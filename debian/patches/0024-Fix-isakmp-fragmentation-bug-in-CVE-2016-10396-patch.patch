From: Thomas Reim <reimth@gmail.com>
Date: Sun, 7 Jun 2020 15:07:14 +0200
Subject: Fix isakmp fragmentation bug in CVE-2016-10396 patch

When applying NetBSD's CVE-2016-10396 patch Apple iPhones, which use a racoon
client for IPSec based VPN access, cannot connect anymore to racoon VPN on
the racoon server. Following server log entries outline the failure:
Sep 14 06:42:28 vpnserver racoon[1775]: ERROR: Repeated fragment index mismatch
Sep 14 06:42:28 vpnserver racoon[1775]: ERROR: Repeated last fragment index mismatch
Sep 14 06:42:32 vpnserver racoon[1775]: ERROR: Repeated fragment index mismatch
Sep 14 06:42:32 vpnserver racoon[1775]: ERROR: Repeated last fragment index mismatch
Sep 14 06:42:35 vpnserver racoon[1775]: ERROR: Repeated fragment index mismatch
Sep 14 06:42:35 vpnserver racoon[1775]: ERROR: Repeated last fragment index mismatch
Sep 14 06:42:35 vpnserver racoon[1775]: ERROR: Repeated fragment index mismatch
Sep 14 06:42:35 vpnserver racoon[1775]: ERROR: Repeated last fragment index mismatch
Sep 14 06:42:39 vpnserver racoon[1775]: ERROR: phase1 negotiation failed due to time up.

This update fixes a bug in the CVE-2016-10396 patch, which prevents racoon
server from identifying a completely reassembled isakmp fragment chain.

In addition, limited debugging has been added, as VPN clients may be blackballed
due to the stricter fragment checks introduced by the CVE-2016-10396 patch.

Bug: http://gnats.netbsd.org/cgi-bin/query-pr-single.pl?number=53646
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/ipsec-tools/+bug/1793028
Applied-Upstream: 1.10, http://cvsweb.netbsd.org/bsdweb.cgi/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?only_with_tag=MAIN

Signed-off-by: Thomas Reim <reimth@gmail.com>
---
 src/racoon/isakmp_frag.c | 27 +++++++++++++++++++++++----
 1 file changed, 23 insertions(+), 4 deletions(-)

diff --git a/src/racoon/isakmp_frag.c b/src/racoon/isakmp_frag.c
index d065b67..f2aba62 100644
--- a/src/racoon/isakmp_frag.c
+++ b/src/racoon/isakmp_frag.c
@@ -182,9 +182,16 @@ isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 	/* no frag yet, just insert at beginning of list */
 	if (iph1->frag_chain == NULL) {
 		iph1->frag_chain = item;
+		plog(LLV_DEBUG, LOCATION, NULL,
+			"first fragment inserted (#%d)\n",
+			item->frag_num);
 		return 0;
 	}
 
+	plog(LLV_DEBUG, LOCATION, NULL,
+		"inserting fragment #%d\n",
+		item->frag_num);
+
 	do {
 		/* duplicate fragment number, abort (CVE-2016-10396) */
 		if (citem->frag_num == item->frag_num)
@@ -224,6 +231,11 @@ isakmp_frag_extract(iph1, msg)
 	char *data;
 	int i;
 
+    if (iph1->frag_chain == NULL) {
+        plog(LLV_DEBUG, LOCATION, NULL,
+            "fragmented IKE phase 1 payload:\n");
+    }
+
 	if (msg->l < sizeof(*isakmp) + sizeof(*frag)) {
 		plog(LLV_ERROR, LOCATION, NULL, "Message too short\n");
 		return -1;
@@ -290,15 +302,22 @@ isakmp_frag_extract(iph1, msg)
 	if (last_frag != 0) {
 		item = iph1->frag_chain;
 		for (i = 1; i <= last_frag; i++) {
-			if (item->frag_num != i)
+			if (item == NULL ||
+			    item->frag_num != i) {
+				plog(LLV_DEBUG, LOCATION, NULL,
+				     "fragment #%d still missing\n",
+				     i);
 				break;
+			}
 			item = item->frag_next;
-			if (item == NULL) /* Not found */
-				break;
 		}
 
-		if (i > last_frag) /* It is complete */
+		if (i > last_frag) {/* It is complete */
+			plog(LLV_DEBUG, LOCATION, NULL,
+			     "Fragment #%d completed payload.\n",
+			     frag->index);
 			return 1;
+		}
 	}
 		
 	return 0;
